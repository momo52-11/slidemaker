<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>SlideMaker ‚Äî Classic</title>
<style>
  :root{
    --bg1:#071a2c;
    --bg2:#0b2744;
    --panel: rgba(16,45,78,.70);
    --stroke: rgba(255,255,255,.12);
    --stroke2: rgba(255,255,255,.18);
    --text: #eaf2ff;
    --muted: rgba(234,242,255,.72);
    --accent: #63a7ff;
    --danger: #ff5a73;
    --ok: #3ddc84;
    --shadow: 0 18px 60px rgba(0,0,0,.35);
    --r: 18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 900px at 20% 20%, rgba(99,167,255,.22), transparent 55%),
      radial-gradient(900px 700px at 80% 80%, rgba(61,220,132,.12), transparent 60%),
      linear-gradient(145deg, var(--bg1), var(--bg2));
    overflow:hidden;
  }

  .app{
    height:100%;
    display:grid;
    grid-template-columns: 320px 1fr;
    gap:16px;
    padding:16px;
  }

  .panel{
    background: var(--panel);
    border:1px solid var(--stroke);
    border-radius: var(--r);
    box-shadow: var(--shadow);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    min-width:0;
  }

  .head{
    padding:14px 14px 10px;
    border-bottom:1px solid var(--stroke);
    display:flex;
    gap:10px;
    align-items:flex-start;
  }
  .logo{
    width:34px;height:34px;border-radius:10px;
    background: linear-gradient(180deg, rgba(99,167,255,.95), rgba(99,167,255,.35));
    display:grid;place-items:center;
    font-weight:900;
    box-shadow: 0 10px 24px rgba(99,167,255,.18);
    flex:0 0 auto;
  }
  .head .h1{font-weight:900;font-size:18px;line-height:1.1}
  .head .sub{font-size:12px;color:var(--muted);margin-top:4px}

  .body{padding:12px 14px; overflow:auto}

  .row{display:flex; gap:10px; flex-wrap:wrap}
  .btn{
    appearance:none;
    border:1px solid var(--stroke2);
    background: rgba(255,255,255,.06);
    color: var(--text);
    padding:9px 10px;
    border-radius:14px;
    cursor:pointer;
    font-weight:800;
    font-size:13px;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
    transition: transform .08s ease, background .15s ease, border-color .15s ease;
  }
  .btn:hover{background:rgba(255,255,255,.10)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:rgba(99,167,255,.16);border-color:rgba(99,167,255,.35)}
  .btn.danger{background:rgba(255,90,115,.12);border-color:rgba(255,90,115,.35)}
  .btn.ok{background:rgba(61,220,132,.12);border-color:rgba(61,220,132,.35)}
  .btn.small{padding:7px 9px; font-size:12px; border-radius:12px}

  .status{
    margin-top:10px;
    display:flex;
    align-items:center;
    gap:8px;
    font-size:12px;
    color:var(--muted);
  }
  .dot{
    width:10px;height:10px;border-radius:50%;
    background: rgba(255,255,255,.18);
    border:1px solid var(--stroke);
  }
  .dot.ok{background:rgba(61,220,132,.85);border-color:rgba(61,220,132,.35)}

  .label{margin:12px 0 6px; font-size:12px; color:var(--muted)}
  select{
    width:100%;
    padding:10px 10px;
    border-radius:14px;
    border:1px solid var(--stroke2);
    background: rgba(0,0,0,.18);
    color: var(--text);
    outline:none;
    font-weight:800;
  }

  .slides{display:flex; flex-direction:column; gap:10px; margin-top:10px}
  .slideItem{
    border:1px solid var(--stroke2);
    background: rgba(255,255,255,.06);
    border-radius:16px;
    padding:10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    cursor:pointer;
    user-select:none;
  }
  .slideItem.active{
    border-color: rgba(99,167,255,.55);
    background: rgba(99,167,255,.10);
    box-shadow: 0 0 0 3px rgba(99,167,255,.10) inset;
  }
  .slideItem .name{font-weight:900;font-size:13px}
  .slideItem .meta{font-size:12px;color:var(--muted)}
  .slideItem .go{opacity:.7; font-weight:900}

  .tips{
    margin-top:12px;
    padding:10px 12px;
    border:1px solid var(--stroke);
    border-radius:16px;
    background: rgba(0,0,0,.12);
    color: var(--muted);
    font-size:12px;
    line-height:1.35;
  }

  .main{
    background: var(--panel);
    border:1px solid var(--stroke);
    border-radius: var(--r);
    box-shadow: var(--shadow);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    min-width:0;
  }

  .topbar{
    padding:12px;
    border-bottom:1px solid var(--stroke);
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
  }
  .spacer{flex:1}

  .stageWrap{
    flex:1;
    display:grid;
    place-items:center;
    padding:14px;
    overflow:hidden;
  }

  /* Classic frame */
  .frame{
    width:min(1120px, 100%);
    aspect-ratio: 16 / 9;
    border-radius:24px;
    border:1px solid rgba(255,255,255,.14);
    background:
      radial-gradient(1000px 700px at 30% 30%, rgba(255,255,255,.07), transparent 60%),
      radial-gradient(900px 700px at 70% 70%, rgba(0,0,0,.22), transparent 60%),
      rgba(10, 30, 55, .35);
    box-shadow:
      0 26px 90px rgba(0,0,0,.35),
      0 0 0 1px rgba(0,0,0,.25) inset;
    position:relative;
    overflow:hidden;
  }
  .inner{
    position:absolute;
    inset:14px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    overflow:hidden;
  }

  /* Themes */
  .theme-ocean{
    background:
      radial-gradient(900px 650px at 25% 25%, rgba(99,167,255,.22), transparent 60%),
      radial-gradient(900px 650px at 80% 80%, rgba(61,220,132,.10), transparent 62%),
      linear-gradient(145deg, #0b2b52, #0a1f38);
  }
  .theme-night{
    background:
      radial-gradient(900px 650px at 30% 30%, rgba(168,99,255,.18), transparent 60%),
      radial-gradient(900px 650px at 75% 75%, rgba(99,167,255,.12), transparent 60%),
      linear-gradient(145deg, #0b0f1e, #0a1b2c);
  }
  .theme-sunset{
    background:
      radial-gradient(900px 650px at 25% 25%, rgba(255,140,90,.18), transparent 60%),
      radial-gradient(900px 650px at 80% 75%, rgba(255,90,170,.10), transparent 60%),
      linear-gradient(145deg, #1b1b3a, #2a1633);
  }
  .theme-paper{
    background:
      radial-gradient(900px 650px at 30% 30%, rgba(0,0,0,.04), transparent 60%),
      linear-gradient(145deg, #f7f7fb, #eceef7);
    color:#111;
  }

  /* Editor elements */
  .el{
    position:absolute;
    border-radius:12px;
    user-select:none;
    -webkit-user-select:none;
    touch-action:none;
    -webkit-tap-highlight-color: transparent;
  }
  .el.selected{
    outline: 2px solid rgba(99,167,255,.75);
    box-shadow: 0 0 0 3px rgba(99,167,255,.15);
  }
  .handle{
    position:absolute;
    width:14px;height:14px;
    right:-6px; bottom:-6px;
    border-radius:6px;
    background: rgba(99,167,255,.95);
    border:2px solid rgba(10,30,55,.85);
    box-shadow: 0 10px 16px rgba(0,0,0,.25);
    cursor:nwse-resize;
  }

  .el.text{
    border:1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.18);
    backdrop-filter: blur(8px);
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding:10px 12px;
  }
  .theme-paper .el.text{
    background: rgba(255,255,255,.75);
    border-color: rgba(0,0,0,.12);
  }

  /* Editable area */
  .txt{
    width:100%;
    height:100%;
    outline:none;
    border:none;
    background:transparent;
    color:inherit;
    font-weight:900;
    line-height:1.05;
    white-space: pre-wrap;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    cursor:text;
  }
  .txt[contenteditable="false"]{ cursor:default; }

  .el.image{
    border:1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.10);
    overflow:hidden;
  }
  .el.image img{
    width:100%;
    height:100%;
    object-fit:contain;
    display:block;
    pointer-events:none; /* ‚úÖ IMPORTANT : sinon l'image bloque le drag */
  }

  /* Presentation */
  .presentOverlay{
    position:fixed;
    inset:0;
    background:
      radial-gradient(1200px 900px at 20% 20%, rgba(99,167,255,.10), transparent 60%),
      radial-gradient(1200px 900px at 80% 80%, rgba(0,0,0,.40), transparent 60%),
      rgba(0,0,0,.88);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
    padding:18px;
  }
  .presentOverlay.show{display:flex}

  .pFrame{
    width:min(1260px, 100%);
    aspect-ratio:16/9;
    border-radius:24px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(10,30,55,.32);
    box-shadow: 0 28px 120px rgba(0,0,0,.6);
    position:relative;
    overflow:hidden;
  }
  .pInner{
    position:absolute;
    inset:14px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    overflow:hidden;
  }
  .pStage{position:absolute; inset:0}

  /* Presentation elements: no boxes */
  .pEl{position:absolute; overflow:hidden}
  .pText{
    background:transparent;
    border:none;
    box-shadow:none;
    padding:0;
    margin:0;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    font-weight:900;
    line-height:1.05;
    white-space: pre-wrap;
  }
  .pImg img{
    width:100%;
    height:100%;
    object-fit:contain;
    display:block;
  }

  /* Tiny HUD */
  .hud{
    position:absolute;
    right:10px;
    bottom:10px;
    display:flex;
    gap:8px;
    align-items:center;
    font-size:10px;
    color: rgba(234,242,255,.78);
    user-select:none;
  }
  .hud .pill{
    padding:5px 7px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.25);
    backdrop-filter: blur(6px);
  }
  .hud button{
    font-size:10px;
    padding:5px 7px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.08);
    color: rgba(234,242,255,.92);
    cursor:pointer;
  }
  .hud button:hover{background:rgba(255,255,255,.12)}

  /* Transitions */
  .t-fade{ animation: fadeIn .28s ease; }
  @keyframes fadeIn{ from{opacity:0; transform:scale(.995)} to{opacity:1; transform:scale(1)} }
  .t-slide{ animation: slideIn .28s ease; }
  @keyframes slideIn{ from{opacity:0; transform:translateX(16px)} to{opacity:1; transform:translateX(0)} }

  @media (max-width: 980px){
    body{overflow:auto}
    .app{grid-template-columns:1fr; grid-template-rows:auto 1fr}
    .main{height:72vh}
  }
</style>
</head>
<body>

<div class="app">
  <aside class="panel">
    <div class="head">
      <div class="logo">S</div>
      <div style="min-width:0">
        <div class="h1">SlideMaker</div>
        <div class="sub">D√©place & √©dite texte/images ‚Äî coords OK en pr√©sentation.</div>
      </div>
    </div>
    <div class="body">
      <div class="row">
        <button class="btn primary" id="addSlide">+ Slide</button>
        <button class="btn" id="dupSlide">Dupliquer</button>
        <button class="btn danger" id="delSlide">Supprimer</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn ok" id="saveBtn">Sauvegarder</button>
        <button class="btn" id="loadBtn">Charger</button>
      </div>

      <div class="status">
        <span class="dot" id="saveDot"></span>
        <span id="saveText">Non sauvegard√©</span>
      </div>

      <div class="label">Slides</div>
      <div class="slides" id="slides"></div>

      <div class="label">Fond / Th√®me</div>
      <select id="themeSel">
        <option value="ocean">Ocean (bleu)</option>
        <option value="night">Night (violet)</option>
        <option value="sunset">Sunset</option>
        <option value="paper">Paper (clair)</option>
      </select>

      <div class="label">Transition</div>
      <select id="transSel">
        <option value="fade">Fondu</option>
        <option value="slide">Glissement</option>
      </select>

      <div class="tips">
        <b>√âdition texte :</b><br>
        ‚Ä¢ PC : <b>double-clic</b> sur le texte pour √©crire<br>
        ‚Ä¢ Mobile/iPad : <b>appui long</b> sur le texte<br>
        ‚Ä¢ Clique ailleurs pour valider<br><br>
        <b>D√©placement :</b> glisse l‚Äôobjet<br>
        <b>Resize :</b> tire le petit carr√©<br>
        <b>Suppr</b> supprime l‚Äôobjet s√©lectionn√©
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <button class="btn primary" id="addText">+ Texte</button>
      <button class="btn primary" id="addImg">+ Image</button>
      <button class="btn" id="textPlus">A+</button>
      <button class="btn" id="textMinus">A-</button>
      <div class="spacer"></div>
      <button class="btn" id="presentBtn">Pr√©sentation</button>
    </div>

    <div class="stageWrap">
      <div class="frame">
        <div class="inner theme-ocean" id="stage"></div>
      </div>
    </div>
  </main>
</div>

<!-- Presentation -->
<div class="presentOverlay" id="pOverlay" aria-hidden="true">
  <div class="pFrame">
    <div class="pInner">
      <div class="pStage theme-ocean" id="pStage"></div>
    </div>
    <div class="hud">
      <div class="pill" id="pCount">1/1</div>
      <button id="pQuit">Quitter</button>
    </div>
  </div>
</div>

<input type="file" id="filePick" accept="image/*" style="display:none" />

<script>
(() => {
  const LS = "slidemaker_fixed_drag_edit_v1";

  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
  const pctToPx = (p, size) => (p/100) * size;
  const pxToPct = (px, size) => (px/size) * 100;

  const stage = document.getElementById("stage");
  const slidesDiv = document.getElementById("slides");

  const themeSel = document.getElementById("themeSel");
  const transSel = document.getElementById("transSel");

  const saveDot = document.getElementById("saveDot");
  const saveText = document.getElementById("saveText");

  const filePick = document.getElementById("filePick");

  const pOverlay = document.getElementById("pOverlay");
  const pStage = document.getElementById("pStage");
  const pCount = document.getElementById("pCount");
  const pQuit = document.getElementById("pQuit");

  let deck = loadDeck() || defaultDeck();
  let selectedId = null;
  let dirty = false;

  // -------- Default deck --------
  function defaultDeck(){
    return {
      version: 1,
      theme: "ocean",
      transition: "fade",
      active: 0,
      slides: [
        {
          id: uid(),
          elements: [
            { id: uid(), type:"text", x:10, y:10, w:48, h:20, z:1, text:"Bienvenue üëã", fontSize:56 },
            { id: uid(), type:"text", x:10, y:36, w:64, h:18, z:1, text:"Double-clic (PC) ou appui long (mobile)\npour modifier le texte.", fontSize:26 }
          ]
        }
      ]
    };
  }

  // -------- Storage --------
  function saveDeck(){
    localStorage.setItem(LS, JSON.stringify(deck));
    setDirty(false);
  }
  function loadDeck(){
    try{
      const raw = localStorage.getItem(LS);
      if(!raw) return null;
      const d = JSON.parse(raw);
      if(!d || !Array.isArray(d.slides) || !d.slides.length) return null;
      return d;
    }catch(e){ return null; }
  }

  function setDirty(v){
    dirty = v;
    if(v){
      saveDot.classList.remove("ok");
      saveText.textContent = "Non sauvegard√©";
    }else{
      saveDot.classList.add("ok");
      saveText.textContent = "Sauvegard√©";
    }
  }

  // -------- Theme helpers --------
  function setThemeClass(el, theme){
    el.classList.remove("theme-ocean","theme-night","theme-sunset","theme-paper");
    el.classList.add("theme-" + (theme || "ocean"));
  }

  // -------- Slide helpers --------
  function activeSlide(){ return deck.slides[deck.active]; }

  function renderSlides(){
    slidesDiv.innerHTML = "";
    deck.slides.forEach((s, idx) => {
      const item = document.createElement("div");
      item.className = "slideItem" + (idx === deck.active ? " active" : "");
      item.innerHTML = `
        <div>
          <div class="name">Slide ${idx+1}</div>
          <div class="meta">${(s.elements||[]).length} objet(s)</div>
        </div>
        <div class="go">‚ñ∂</div>
      `;
      item.addEventListener("click", () => {
        deck.active = idx;
        selectedId = null;
        renderAll();
      });
      slidesDiv.appendChild(item);
    });
  }

  function addSlide(){
    deck.slides.push({ id: uid(), elements: [] });
    deck.active = deck.slides.length - 1;
    selectedId = null;
    setDirty(true);
    renderAll();
  }

  function duplicateSlide(){
    const s = activeSlide();
    const clone = {
      id: uid(),
      elements: (s.elements||[]).map(e => ({...structuredClone(e), id: uid()}))
    };
    deck.slides.splice(deck.active+1, 0, clone);
    deck.active++;
    selectedId = null;
    setDirty(true);
    renderAll();
  }

  function deleteSlide(){
    if(deck.slides.length <= 1) return;
    deck.slides.splice(deck.active, 1);
    deck.active = clamp(deck.active, 0, deck.slides.length-1);
    selectedId = null;
    setDirty(true);
    renderAll();
  }

  // -------- Elements ops --------
  function addText(){
    const s = activeSlide();
    const el = { id: uid(), type:"text", x:10, y:10, w:36, h:20, z:1, text:"Texte", fontSize:48 };
    s.elements.push(el);
    selectedId = el.id;
    setDirty(true);
    renderStage();
    updateSelectionUI();
  }

  function addImageFromFile(file){
    const r = new FileReader();
    r.onload = () => {
      const s = activeSlide();
      const el = { id: uid(), type:"image", x:10, y:10, w:44, h:44, z:1, src: r.result };
      s.elements.push(el);
      selectedId = el.id;
      setDirty(true);
      renderStage();
      updateSelectionUI();
    };
    r.readAsDataURL(file);
  }

  function bumpText(delta){
    if(!selectedId) return;
    const s = activeSlide();
    const el = s.elements.find(e => e.id === selectedId);
    if(!el || el.type !== "text") return;
    el.fontSize = clamp((el.fontSize || 36) + delta, 10, 220);
    setDirty(true);
    const node = stage.querySelector(`.el[data-id="${selectedId}"] .txt`);
    if(node) node.style.fontSize = el.fontSize + "px";
  }

  function deleteSelected(){
    if(!selectedId) return;
    const s = activeSlide();
    const idx = s.elements.findIndex(e => e.id === selectedId);
    if(idx >= 0){
      s.elements.splice(idx, 1);
      selectedId = null;
      setDirty(true);
      renderStage();
    }
  }

  // -------- Rendering stage --------
  function renderStage(){
    stage.innerHTML = "";
    setThemeClass(stage, deck.theme);

    const s = activeSlide();
    const rect = stage.getBoundingClientRect();

    const els = [...(s.elements||[])].sort((a,b)=> (a.z||1)-(b.z||1));
    els.forEach(model => {
      const node = document.createElement("div");
      node.className = "el " + (model.type === "text" ? "text" : "image");
      node.dataset.id = model.id;

      const left = pctToPx(model.x, rect.width);
      const top  = pctToPx(model.y, rect.height);
      const w    = pctToPx(model.w, rect.width);
      const h    = pctToPx(model.h, rect.height);

      node.style.left = left + "px";
      node.style.top = top + "px";
      node.style.width = w + "px";
      node.style.height = h + "px";
      node.style.zIndex = String(model.z || 1);

      if(model.type === "text"){
        const txt = document.createElement("div");
        txt.className = "txt";
        txt.setAttribute("contenteditable","false");
        txt.spellcheck = false;
        txt.style.fontSize = (model.fontSize || 36) + "px";
        txt.textContent = model.text || "Texte";
        node.appendChild(txt);

        txt.addEventListener("dblclick", (e)=>{
          e.stopPropagation();
          startEditing(txt, model);
        });

        attachLongPressToEdit(txt, model);

        txt.addEventListener("blur", ()=>{
          if(txt.getAttribute("contenteditable") === "true"){
            model.text = txt.textContent;
            txt.setAttribute("contenteditable","false");
            setDirty(true);
          }
        });

        txt.addEventListener("keydown", (e)=>{
          if(txt.getAttribute("contenteditable") !== "true") return;
          if(e.key === "Enter" && !e.shiftKey){
            e.preventDefault();
            txt.blur();
          }
        });
      } else {
        const img = document.createElement("img");
        img.alt = "";
        img.src = model.src || "";
        node.appendChild(img);
      }

      const handle = document.createElement("div");
      handle.className = "handle";
      node.appendChild(handle);

      node.addEventListener("pointerdown", (e)=>{
        const txt = node.querySelector(".txt");
        if(txt && (e.target === txt || txt.contains(e.target))) return; // ‚úÖ IMPORTANT : ne pas lancer drag si on clique le texte
        if(txt && txt.getAttribute("contenteditable") === "true") return;
        select(model.id);
      });

      makeDragResize(node, handle, model);
      stage.appendChild(node);
    });

    updateSelectionUI();
    stage.addEventListener("pointerdown", onStageEmptyDown, { once:true });
  }

  function onStageEmptyDown(e){
    if(e.target === stage){
      selectedId = null;
      updateSelectionUI();
    }else{
      stage.addEventListener("pointerdown", onStageEmptyDown, { once:true });
    }
  }

  function select(id){
    selectedId = id;
    updateSelectionUI();
  }

  function updateSelectionUI(){
    const nodes = stage.querySelectorAll(".el");
    nodes.forEach(n => n.classList.toggle("selected", n.dataset.id === selectedId));
  }

  function startEditing(txtNode, model){
    selectedId = model.id;
    updateSelectionUI();
    txtNode.setAttribute("contenteditable","true");
    txtNode.focus();
    placeCaretEnd(txtNode);
  }

  function placeCaretEnd(el){
    const range = document.createRange();
    range.selectNodeContents(el);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }

  function attachLongPressToEdit(txtNode, model){
    let t = null;
    let startX=0, startY=0;

    txtNode.addEventListener("pointerdown", (e)=>{
      if(txtNode.getAttribute("contenteditable")==="true") return;
      startX = e.clientX; startY = e.clientY;
      if(e.pointerType === "touch" || e.pointerType === "pen"){
        t = setTimeout(()=> startEditing(txtNode, model), 450);
      }
    });

    txtNode.addEventListener("pointermove", (e)=>{
      if(!t) return;
      if(Math.abs(e.clientX-startX) > 8 || Math.abs(e.clientY-startY) > 8){
        clearTimeout(t); t = null;
      }
    });

    txtNode.addEventListener("pointerup", ()=>{ if(t){ clearTimeout(t); t = null; } });
    txtNode.addEventListener("pointercancel", ()=>{ if(t){ clearTimeout(t); t = null; } });
  }

  function makeDragResize(node, handle, model){
    let mode = null;
    let start = null;

    const stageRect = () => stage.getBoundingClientRect();

    const down = (e, m)=>{
      const txt = node.querySelector(".txt");
      if(m === "drag" && txt && (e.target === txt || txt.contains(e.target))) return; // ‚úÖ IMPORTANT : drag seulement si on clique pas le texte
      if(m === "drag" && txt && txt.getAttribute("contenteditable")==="true") return;

      e.preventDefault();
      e.stopPropagation();

      node.setPointerCapture(e.pointerId);
      mode = m;

      const rect = stageRect();
      const box = node.getBoundingClientRect();

      start = {
        pid: e.pointerId,
        x0: e.clientX, y0: e.clientY,
        rectW: rect.width, rectH: rect.height,
        leftPx: box.left - rect.left,
        topPx: box.top - rect.top,
        wPx: box.width,
        hPx: box.height
      };
    };

    node.addEventListener("pointerdown", (e)=>{
      if(e.target === handle) return;
      down(e, "drag");
    });

    handle.addEventListener("pointerdown", (e)=> down(e, "resize"));

    node.addEventListener("pointermove", (e)=>{
      if(!start || e.pointerId !== start.pid) return;

      const dx = e.clientX - start.x0;
      const dy = e.clientY - start.y0;

      if(mode === "drag"){
        let newLeft = start.leftPx + dx;
        let newTop  = start.topPx + dy;

        newLeft = clamp(newLeft, 0, start.rectW - start.wPx);
        newTop  = clamp(newTop, 0, start.rectH - start.hPx);

        node.style.left = newLeft + "px";
        node.style.top  = newTop + "px";

        model.x = clamp(pxToPct(newLeft, start.rectW), 0, 100 - model.w);
        model.y = clamp(pxToPct(newTop, start.rectH), 0, 100 - model.h);
        setDirty(true);
      }

      if(mode === "resize"){
        let newW = start.wPx + dx;
        let newH = start.hPx + dy;

        newW = clamp(newW, 24, start.rectW - start.leftPx);
        newH = clamp(newH, 24, start.rectH - start.topPx);

        node.style.width = newW + "px";
        node.style.height= newH + "px";

        model.w = clamp(pxToPct(newW, start.rectW), 2, 100 - model.x);
        model.h = clamp(pxToPct(newH, start.rectH), 2, 100 - model.y);
        setDirty(true);
      }
    });

    const up = (e)=>{
      if(!start || e.pointerId !== start.pid) return;
      start = null;
      mode = null;
    };

    node.addEventListener("pointerup", up);
    node.addEventListener("pointercancel", up);
  }

  // -------- Presentation --------
  let presenting = false;
  let pIndex = 0;

  async function requestFs(){
    try{
      if(!document.fullscreenElement){
        await document.documentElement.requestFullscreen();
      }
    }catch(e){}
  }
  async function exitFs(){
    try{
      if(document.fullscreenElement){
        await document.exitFullscreen();
      }
    }catch(e){}
  }

  async function openPresentation(){
    await requestFs(); // ‚úÖ plein √©cran comme avant
    presenting = true;
    pIndex = deck.active;
    pOverlay.classList.add("show");
    pOverlay.setAttribute("aria-hidden","false");
    renderPresent();
  }

  async function closePresentation(){
    presenting = false;
    pOverlay.classList.remove("show");
    pOverlay.setAttribute("aria-hidden","true");
    pStage.innerHTML = "";
    deck.active = clamp(pIndex, 0, deck.slides.length-1);
    renderAll();
    await exitFs(); // ‚úÖ sortir du plein √©cran
  }

  function renderPresent(){
    pStage.innerHTML = "";
    setThemeClass(pStage, deck.theme);

    const t = (deck.transition === "slide") ? "t-slide" : "t-fade";
    pStage.classList.remove("t-fade","t-slide");
    void pStage.offsetWidth;
    pStage.classList.add(t);

    const s = deck.slides[pIndex];
    if(!s) return;

    pCount.textContent = `${pIndex+1}/${deck.slides.length}`;

    const rect = pStage.getBoundingClientRect();
    const els = [...(s.elements||[])].sort((a,b)=> (a.z||1)-(b.z||1));

    els.forEach(el=>{
      const node = document.createElement("div");
      node.className = "pEl " + (el.type==="text" ? "pText" : "pImg");

      node.style.left = pctToPx(el.x, rect.width) + "px";
      node.style.top  = pctToPx(el.y, rect.height) + "px";
      node.style.width= pctToPx(el.w, rect.width) + "px";
      node.style.height=pctToPx(el.h, rect.height) + "px";
      node.style.zIndex = String(el.z||1);

      if(el.type==="text"){
        node.style.fontSize = (el.fontSize || 36) + "px";
        node.textContent = el.text || "";
      }else{
        const img = document.createElement("img");
        img.alt = "";
        img.src = el.src || "";
        node.appendChild(img);
      }
      pStage.appendChild(node);
    });
  }

  function nextOrExit(){
    if(pIndex < deck.slides.length - 1){
      pIndex++;
      renderPresent();
    }else{
      closePresentation();
    }
  }

  function prev(){
    if(pIndex > 0){
      pIndex--;
      renderPresent();
    }
  }

  pOverlay.addEventListener("click", (e)=>{
    if(e.target === pQuit) return;
    nextOrExit();
  });

  pQuit.addEventListener("click", (e)=>{
    e.stopPropagation();
    closePresentation();
  });

  window.addEventListener("keydown", (e)=>{
    if(presenting){
      if(e.key === "Escape") closePresentation();
      else if(e.key === "ArrowRight" || e.key === " " || e.key === "Enter"){ e.preventDefault(); nextOrExit(); }
      else if(e.key === "ArrowLeft"){ e.preventDefault(); prev(); }
      return;
    }

    if(e.key === "Delete" || e.key === "Backspace"){
      const ae = document.activeElement;
      if(ae && ae.classList && ae.classList.contains("txt") && ae.getAttribute("contenteditable")==="true"){
        return;
      }
      deleteSelected();
    }
  });

  window.addEventListener("resize", ()=>{
    renderStage();
    if(presenting) renderPresent();
  });

  function renderAll(){
    themeSel.value = deck.theme || "ocean";
    transSel.value = deck.transition || "fade";
    renderSlides();
    renderStage();
  }

  // -------- UI bindings --------
  document.getElementById("addSlide").addEventListener("click", addSlide);
  document.getElementById("dupSlide").addEventListener("click", duplicateSlide);
  document.getElementById("delSlide").addEventListener("click", deleteSlide);

  document.getElementById("saveBtn").addEventListener("click", saveDeck);
  document.getElementById("loadBtn").addEventListener("click", ()=>{
    const d = loadDeck();
    if(d){
      deck = d;
      selectedId = null;
      setDirty(false);
      renderAll();
    }
  });

  document.getElementById("addText").addEventListener("click", addText);
  document.getElementById("addImg").addEventListener("click", ()=> filePick.click());
  filePick.addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if(f) addImageFromFile(f);
    filePick.value = "";
  });

  document.getElementById("textPlus").addEventListener("click", ()=> bumpText(+4));
  document.getElementById("textMinus").addEventListener("click", ()=> bumpText(-4));

  document.getElementById("presentBtn").addEventListener("click", openPresentation);

  themeSel.addEventListener("change", ()=>{
    deck.theme = themeSel.value;
    setDirty(true);
    renderStage();
    if(presenting) renderPresent();
  });

  transSel.addEventListener("change", ()=>{
    deck.transition = transSel.value;
    setDirty(true);
  });

  setDirty(false);
  renderAll();

})();
</script>
</body>
</html>
